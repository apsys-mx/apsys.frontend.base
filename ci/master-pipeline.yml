trigger:
    - master

pr: none

variables:
    - group: project-variables-group
    - name: projectName
      value: 'apsys.frontend.base.turkey'
    - name: packageSuffix
      value: ''
    - name: buildScript
      value: 'build:prd'
    - name: octopus.spaceName
      value: 'apsys-mx'
    - name: octopus.server
      value: 'https://apsys-fs-cloud.octopus.app'
    - name: octopus.channel
      value: 'Default'
    - name: octopus.developmentName
      value: 'Development'
    - name: octopus.testingName
      value: 'Testing'

pool:
    name: 'Default'
    vmImage: 'windows-latest'

jobs:
    - job: BuildTestsPack
      displayName: Build, test and pack
      steps:
          - checkout: self
            fetchDepth: 0
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
                versionSpec: '18.x'
          - script: npm install
            displayName: 'Install packages'
          - template: 'templates-sonar/sonar-cloud-prepare.yml'
            parameters:
              sonarServiceName: ${{variables.sonarServiceName}}
              sonarProjectKey: ${{variables.sonarProjectKey}}
              sonarProjectName: ${{variables.sonarProjectName}}
              sonarCloudOrganization: ${{variables.sonarCloudOrganization}}
          - script: npm run $(buildScript)
            displayName: 'Build project'
          - template: 'templates-sonar/sonar-cloud-execute.yml'
            parameters:
              sonarServiceName: ${{variables.sonarServiceName}}
              sonarCloudOrganization: ${{variables.sonarCloudOrganization}}
          - task: CmdLine@2
            enabled: true
            displayName: 'Pack artifact for $(projectName)'
            inputs:
                script: '"ci/octo" pack --id="$(projectName)" --format="NuPkg" --version="$(Build.BuildNumber)$(packageSuffix)" --basePath="dist" --author="APSYS" --title="$(projectName) package" --description="frontend package for $(projectName)"'
          - task: CmdLine@2
            enabled: true
            displayName: 'Push $(projectName) package to Octopus'
            inputs:
                script: '"ci/octo" push --package="$(projectName).$(Build.BuildNumber)$(packageSuffix).nupkg" --server="$(octopus.server)" --space="$(octopus.spaceName)" --apiKey="$(OctopusAPIKey)"'

    - job: DeployApplication
      dependsOn:
          - BuildTestsPack
      displayName: Deploy to environments
      steps:
          - checkout: none
          - task: CmdLine@2
            enabled: true
            displayName: 'Create releases'
            inputs:
                script: '"ci/octo" create-release --project $(projectName) --server "$(octopus.server)" --apiKey="$(OctopusAPIKey)" --space="$(octopus.spaceName)" --channel "$(octopus.channel)" --version "$(Build.BuildNumber)$(packageSuffix)"'
          - task: CmdLine@2
            enabled: true
            displayName: 'Deploy to $(octopus.developmentName)'
            inputs:
                script: '"ci/octo" deploy-release --project $(projectName) --server "$(octopus.server)" --apiKey="$(OctopusAPIKey)" --space="$(octopus.spaceName)" --channel "$(octopus.channel)" --version "$(Build.BuildNumber)$(packageSuffix)" --deployto "$(octopus.developmentName)"  --waitForDeployment --progress'
          - task: CmdLine@2
            enabled: true
            displayName: 'Deploy to $(octopus.testingName)'
            inputs:
                script: '"ci/octo" deploy-release --project $(projectName) --server "$(octopus.server)" --apiKey="$(OctopusAPIKey)" --space="$(octopus.spaceName)" --channel "$(octopus.channel)" --version "$(Build.BuildNumber)$(packageSuffix)" --deployto "$(octopus.testingName)"  --waitForDeployment --progress'
